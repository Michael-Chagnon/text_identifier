<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <link href="static/css/style.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Draw a Digit</title>
    </head>
    <body>
        <div id="character-container">
            <img id="character" src="static/images/heads/happy.png" alt="Character" />
            
            <!-- Speech bubble -->
            <div id="speech-bubble">
                <p>I am NumBuddy! <a href="#" id="learn-more-link">Click here</a> to learn more about me.</p>
            </div>
        </div>

        <div id="numbuddy-info" class="modal" style="display: none;">
            <div class="modal-content">
                <span id="close-modal" class="close">&times;</span>
                <h2>Meet Numbuddy!</h2>
                <p>Numbuddy is an AI model trained using the MNIST dataset to recognize handwritten numbers. Pulling from thousands of examples, it has learned to accurately predict hand-drawn digits from 0 to 9.</p>
                <p><b>Some of Numbuddy's features include:</b></p>
                <ul>
                    <li>Interactive number recognition – draw your number, and Numbuddy will guess it in real-time.</li>
                    <li>History tracker – keep a log of your past predictions and drawings for future reference.</li>
                    <li>Custom responses – watch as Numbuddy reacts with different poses and expressions based on its confidence in its predictions!</li>
                </ul>
                <br/>
                <p>Numbuddy is also great for experimenting with different scenarios and outlier cases. You can test how the model reacts when numbers are drawn ambiguously, such as drawing numbers on top of one another. In such cases, Numbuddy may feel uncertain and often attempts to choose between two or three numbers that appear similar. You can observe this behavior through the prediction confidence bar, where lower confidence indicates that the model is unsure about its choice.  </p>
            </div>
        </div>
               
        <h1>Draw a Digit</h1>
    <canvas id="canvas" width="280" height="280" style="border:1px solid #000;"></canvas>

    <!-- Button Container to align buttons horizontally -->
    <div class="button-container">
        <button id="clear">Clear</button>
        <button id="predict">Predict</button>
    </div>

    <p>Predicted Digit: <span id="result"></span><div id="loading-dots" class="dots" style="display: none;">
        <div class="dot dot1"></div>
        <div class="dot dot2"></div>
        <div class="dot dot3"></div>
    </div>  </p>    

    <!-- Header and Chart Section -->
    <div class="confidence-bar" id="confidence-bar">
        <h2>Prediction Confidence</h2>
        <div id="confidence-container">
            <div class="bar" id="bar-0"></div>
            <div class="bar" id="bar-1"></div>
            <div class="bar" id="bar-2"></div>
            <div class="bar" id="bar-3"></div>
            <div class="bar" id="bar-4"></div>
            <div class="bar" id="bar-5"></div>
            <div class="bar" id="bar-6"></div>
            <div class="bar" id="bar-7"></div>
            <div class="bar" id="bar-8"></div>
            <div class="bar" id="bar-9"></div>
        </div>
        <div id="confidence-labels">
            <span class="bar-label">0</span>
            <span class="bar-label">1</span>
            <span class="bar-label">2</span>
            <span class="bar-label">3</span>
            <span class="bar-label">4</span>
            <span class="bar-label">5</span>
            <span class="bar-label">6</span>
            <span class="bar-label">7</span>
            <span class="bar-label">8</span>
            <span class="bar-label">9</span>
        </div>
    </div>

    <div id="history-container">
        <h2>Prediction History</h2>
        <div id="history-content"></div>
    </div>
    
            


    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        canvas.addEventListener('mousedown', () => { isDrawing = true; });
        canvas.addEventListener('mouseup', () => { isDrawing = false; ctx.beginPath(); });
        canvas.addEventListener('mousemove', draw);

        function draw(event) {
            if (!isDrawing) return;
            ctx.lineWidth = 15;
            ctx.lineCap = 'round';
            ctx.strokeStyle = 'black';

            ctx.lineTo(event.clientX - canvas.offsetLeft, event.clientY - canvas.offsetTop);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(event.clientX - canvas.offsetLeft, event.clientY - canvas.offsetTop);
        }

        document.getElementById('clear').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        function updateCharacterFace(confidence) {
        const characterImg = document.getElementById('character');

        console.log(confidence)

        if (confidence > 0.9) {
            characterImg.src = 'static/images/heads/happy.png';  // High confidence face
        } else if (confidence > 0.8) {
            characterImg.src = 'static/images/heads/flat.png';    // Moderate confidence face
        } else {
            characterImg.src = 'static/images/heads/angry.png';    // Low confidence face
        }
    }


    document.getElementById('learn-more-link').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('numbuddy-info').style.display = 'block';
        const overlay = document.createElement('div');
        overlay.classList.add('modal-overlay');
        document.body.appendChild(overlay);  // Add overlay when modal is opened
    });

    document.getElementById('close-modal').addEventListener('click', function() {
        document.getElementById('numbuddy-info').style.display = 'none';
        const overlay = document.querySelector('.modal-overlay');
        if (overlay) overlay.remove();  // Remove overlay when modal is closed
    });



    document.getElementById('predict').addEventListener('click', async () => {
        const characterImg = document.getElementById('character');
        const loadingDots = document.getElementById('loading-dots');
        const resultElement = document.getElementById('result');

        // Set character face to thinking when starting the prediction process
        characterImg.src = 'static/images/heads/flat2.png';
        resultElement.innerText = ""; // Optional text display
        loadingDots.style.display = 'inline-block'; // Show the loading dots

        const dataUrl = canvas.toDataURL('image/png');
        const blob = await fetch(dataUrl).then(res => res.blob());

        const formData = new FormData();
        formData.append('image', blob, 'digit.png');

        try {
            const response = await fetch('/predict', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error:', errorText);
                resultElement.innerText = 'Error predicting digit.';
                loadingDots.style.display = 'none'; // Hide the dots on error
                return;
            }

            // Add a delay before showing the result to simulate "thinking"
            setTimeout(async () => {
                const result = await response.json();
                const prediction = result.prediction[0];
                const confidenceScores = result.confidence_scores;

                // Find the maximum confidence score
                const maxConfidence = Math.max(...confidenceScores);

                // Update predicted result
                resultElement.innerText = prediction;
                loadingDots.style.display = 'none'; // Hide the loading dots after prediction

                // Update the confidence bars
                confidenceScores.forEach((score, index) => {
                    const bar = document.getElementById(`bar-${index}`);
                    bar.style.height = `${Math.max(score * 100, 2)}%`;
                });

                // Update character face based on the highest confidence
                updateCharacterFace(maxConfidence);

                // Create history item
                const historyItem = document.createElement('div');
                historyItem.classList.add('history-item');
                
                // Create image element
                const img = document.createElement('img');
                img.src = dataUrl; // Use the drawn image
                img.alt = `Drawn digit: ${prediction}`;
                
                // Create prediction text element
                const predictionText = document.createElement('span');
                predictionText.innerText = `Predicted: ${prediction}`;

                // Append image and text to history item
                historyItem.appendChild(img);
                historyItem.appendChild(predictionText);

                // Prepend new history item to the top of the list
                const historyContent = document.getElementById('history-content');
                historyContent.insertBefore(historyItem, historyContent.firstChild);
            }, 2000); // Delay for 2 seconds before showing the result
        } catch (error) {
            console.error('Fetch error:', error);
            loadingDots.style.display = 'none'; // Hide the dots on error
        }
    });
    </script>
</body>
</html>
